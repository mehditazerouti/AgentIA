<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent IA Avanc√© - Architecture BDI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
    <style>
        .terminal { background-color: #1e1e1e; color: #00ff00; font-family: 'Courier New', monospace; }
        @keyframes scan { 0% { background-position: 0% 0%; } 100% { background-position: 0% 100%; } }
        .scanning { background: linear-gradient(to bottom, transparent 50%, rgba(0, 255, 0, 0.1) 51%); background-size: 100% 4px; animation: scan 10s linear infinite; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-6">
    
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- COLONNE GAUCHE : CLIENT -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Header -->
            <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-600">
                <h1 class="text-3xl font-bold text-slate-800">ü§ñ Agent de R√©servation Cognitif</h1>
                <p class="text-slate-500">Architecture BDI (Beliefs-Desires-Intentions) connect√©e via API</p>
            </div>

            <!-- Formulaire -->
            <div class="bg-white p-8 rounded-xl shadow-md">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <i data-lucide="calendar"></i> Faire une r√©servation
                </h2>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Date</label>
                        <input id="dateInput" type="date" class="w-full mt-1 p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Heure souhait√©e</label>
                        <select id="timeInput" class="w-full mt-1 p-2 border rounded"></select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700">Nom</label>
                    <input id="nameInput" type="text" class="w-full mt-1 p-2 border rounded" placeholder="Votre nom">
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-700">Personnes</label>
                    <input id="partyInput" type="number" value="2" min="1" max="8" class="w-full mt-1 p-2 border rounded">
                </div>

                <button onclick="makeReservation()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition flex justify-center items-center gap-2">
                    <span>Envoyer √† l'Agent</span>
                    <i data-lucide="send"></i>
                </button>
            </div>

            <!-- R√©sultat de l'IA -->
            <div id="resultBox" class="hidden p-6 rounded-xl border-l-4 shadow-md bg-white">
                <h3 id="resultTitle" class="font-bold text-lg"></h3>
                <p id="resultMessage" class="mt-2 text-slate-700"></p>
            </div>
        </div>

        <!-- COLONNE DROITE : CERVEAU & ADMIN -->
        <div class="space-y-6">
            
            <!-- Visualisation du Cerveau (Debug BDI) -->
            <div class="bg-black rounded-xl shadow-xl overflow-hidden text-green-400 border border-green-800 terminal">
                <div class="p-3 bg-gray-900 border-b border-gray-800 flex justify-between items-center">
                    <span class="font-bold flex items-center gap-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        AI BRAIN LOGS
                    </span>
                    <span class="text-xs text-gray-500">API: Connected</span>
                </div>
                <div id="brainLogs" class="p-4 h-64 overflow-y-auto text-xs font-mono scanning space-y-2">
                    <div class="opacity-50">> System initialized...</div>
                    <div class="opacity-50">> Waiting for input...</div>
                </div>
            </div>

            <!-- Planning Actuel -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="font-bold text-slate-800 mb-4">Beliefs (√âtat du monde)</h3>
                <div id="planningGrid" class="space-y-2 max-h-60 overflow-y-auto"></div>
            </div>

            <!-- Panel Admin -->
            <div class="bg-slate-800 text-white p-6 rounded-xl shadow-md">
                <h3 class="font-bold mb-4 flex items-center gap-2">
                    <i data-lucide="settings"></i> Configuration Syst√®me
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-slate-400">Capacit√© Max par cr√©neau</label>
                        <input id="adminCapacity" type="number" class="w-full bg-slate-700 border-none rounded p-2 mt-1 text-white">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400">Message Succ√®s</label>
                        <input id="adminMsgSuccess" type="text" class="w-full bg-slate-700 border-none rounded p-2 mt-1 text-white">
                    </div>
                    <button onclick="updateConfig()" class="w-full bg-green-600 hover:bg-green-700 py-2 rounded text-sm font-bold">
                        Mettre √† jour via API
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Configuration API
        const API_URL = 'http://127.0.0.1:8000/api';
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
            lucide.createIcons();
            loadSlots();
            loadConfig();
        });

        // --- FONCTIONS LOGIQUES ---

        async function loadConfig() {
            const res = await fetch(`${API_URL}/config`);
            const data = await res.json();
            document.getElementById('adminCapacity').value = data.config.max_capacity;
            document.getElementById('adminMsgSuccess').value = data.messages.success;
            logBrain("Configuration loaded from server.");
        }

        async function loadSlots() {
            const date = document.getElementById('dateInput').value;
            const res = await fetch(`${API_URL}/slots?date=${date}`);
            const slots = await res.json();
            
            const timeSelect = document.getElementById('timeInput');
            const planningGrid = document.getElementById('planningGrid');
            
            timeSelect.innerHTML = '';
            planningGrid.innerHTML = '';

            slots.forEach(slot => {
                // Remplir Select
                const opt = document.createElement('option');
                opt.value = slot.time;
                opt.text = `${slot.time} (${slot.available} places)`;
                timeSelect.appendChild(opt);

                // Remplir Visualisation Planning
                const div = document.createElement('div');
                const percent = (slot.booked / slot.capacity) * 100;
                div.className = "flex justify-between items-center text-sm p-2 bg-slate-50 rounded";
                div.innerHTML = `
                    <span>${slot.time}</span>
                    <div class="flex items-center gap-2">
                        <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full ${percent > 80 ? 'bg-red-500' : 'bg-green-500'}" style="width: ${percent}%"></div>
                        </div>
                        <span class="font-mono text-xs">${slot.booked}/${slot.capacity}</span>
                    </div>
                `;
                planningGrid.appendChild(div);
            });
        }

        async function makeReservation() {
            const payload = {
                date: document.getElementById('dateInput').value,
                time: document.getElementById('timeInput').value,
                name: document.getElementById('nameInput').value,
                party_size: parseInt(document.getElementById('partyInput').value)
            };

            logBrain(`INCOMING REQUEST: ${payload.name} for ${payload.time} (${payload.party_size} pax)`);
            logBrain(`ANALYZING: Calculating Utility Scores based on Proximity & Load...`);

            const res = await fetch(`${API_URL}/reserve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const result = await res.json();
            
            // Affichage R√©sultat Client
            const box = document.getElementById('resultBox');
            const title = document.getElementById('resultTitle');
            const msg = document.getElementById('resultMessage');
            
            box.classList.remove('hidden', 'border-green-500', 'border-yellow-500', 'border-red-500');
            
            if (result.action === 'ACCEPT') {
                box.classList.add('border-green-500', 'bg-green-50');
                title.textContent = '‚úÖ R√©servation Confirm√©e';
                title.className = 'font-bold text-lg text-green-700';
            } else if (result.action === 'ALTERNATIVE') {
                box.classList.add('border-yellow-500', 'bg-yellow-50');
                title.textContent = 'üìç Alternative Propos√©e';
                title.className = 'font-bold text-lg text-yellow-700';
            } else {
                box.classList.add('border-red-500', 'bg-red-50');
                title.textContent = '‚ùå √âchec';
                title.className = 'font-bold text-lg text-red-700';
            }
            
            msg.textContent = `${result.message} (${result.reasoning})`;
            
            // Log Brain
            logBrain(`DECISION: ${result.action}`);
            logBrain(`REASON: ${result.reasoning}`);
            
            loadSlots(); // Rafraichir le planning
        }

        async function updateConfig() {
            const payload = {
                max_capacity: parseInt(document.getElementById('adminCapacity').value),
                success_message: document.getElementById('adminMsgSuccess').value
            };
            
            await fetch(`${API_URL}/admin/config`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            logBrain("SYSTEM UPDATE: Configuration modified by Admin.");
            alert("Configuration sauvegard√©e !");
            loadSlots();
        }

        function logBrain(text) {
            const logs = document.getElementById('brainLogs');
            const entry = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="text-gray-500">[${time}]</span> ${text}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        document.getElementById('dateInput').addEventListener('change', loadSlots);
    </script>
</body>
</html>